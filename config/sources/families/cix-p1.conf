#
# SPDX-License-Identifier: GPL-2.0
#
# Copyright (c) 2013-2023 Igor Pecovnik, igor@armbian.com
#
# This file is a part of the Armbian Build Framework
# https://github.com/armbian/build/
#

declare -g LINUXFAMILY="cix-p1"
declare -g ARCH="arm64"
declare -g BOOTCONFIG="none"
declare -g UEFI_GRUB_TIMEOUT=3
declare -g SERIALCON="ttyAMA2"

case $BRANCH in

	2025-Q3)
		declare -g KERNEL_MAJOR_MINOR="6.6" # Major and minor versions of this kernel.
		declare -g LINUXCONFIG='linux-cix-2025-Q3'
		KERNELSOURCE='https://github.com/radxa/kernel.git'
		KERNELBRANCH='branch:ee8f6/48bff/cix_p1_K6.6_2025Q3_dev_patch'
		KERNELPATCHDIR='cix-2025-Q3'
		declare -g -i KERNEL_GIT_CACHE_TTL=120 # 2 minutes; this is a high-traffic repo
		enable_extension "grub"
		#declare -g GRUB_CMDLINE_LINUX_DEFAULT="acpi=force kasan=off rootwait rw"
		declare -g GRUB_CMDLINE_LINUX_DEFAULT="loglevel=0 acpi=force kasan=off rootwait rw pcie_aspm=off linlon-dp.enable_render=0" # linlon-dp for Panthor
		declare -g EXTRAWIFI="no"
		# Disable boot logo/splash parameters that grub extension adds
		declare -g BOOT_LOGO="no"
		;;

esac

family_tweaks_bsp() {
	:
}

post_family_tweaks_bsp__cix_gpu_firmware() {
	# Only add GPU firmware for 2025-Q3 branch
	if [[ "${BRANCH}" != "2025-Q3" ]]; then
		return 0
	fi

	display_alert "Adding CIX GPU firmware" "mali_csffw.bin" "info"

	# Firmware commit SHA from cix-linux proprietary repo
	declare firmware_commit_sha1="06fe36730b79ad9969f537571b0cf6395ed82c5a"

	# Destination directory for firmware
	declare destdir="${destination}/usr/lib/firmware"
	run_host_command_logged mkdir -p "${destdir}"

	# Fetch the firmware from GitLab
	fetch_from_repo "https://gitlab.com/cix-linux/cix_proprietary/cix_proprietary.git" "cix-gpu-firmware" "commit:${firmware_commit_sha1}" "yes"

	# Source directory where the firmware is located
	declare srcdir="${SRC}/cache/sources/cix-gpu-firmware/${firmware_commit_sha1}"

	# Copy the Mali CSF firmware file
	if [[ -f "${srcdir}/cix_proprietary-debs/cix-gpu-umd/usr/lib/firmware/mali_csffw.bin" ]]; then
		run_host_command_logged cp -v "${srcdir}/cix_proprietary-debs/cix-gpu-umd/usr/lib/firmware/mali_csffw.bin" "${destdir}/mali_csffw.bin"
		display_alert "CIX GPU firmware installed successfully" "mali_csffw.bin" "info"
	else
		display_alert "CIX GPU firmware file not found" "mali_csffw.bin" "wrn"
	fi
}
