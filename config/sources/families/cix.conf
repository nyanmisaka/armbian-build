#
# SPDX-License-Identifier: GPL-2.0
#
# Copyright (c) 2013-2023 Igor Pecovnik, igor@armbian.com
#
# This file is a part of the Armbian Build Framework
# https://github.com/armbian/build/
#

declare -g LINUXFAMILY="cix"
declare -g ARCH="arm64"
declare -g BOOTCONFIG="none"

case $BRANCH in

	2025-Q3)
		declare -g KERNEL_MAJOR_MINOR="6.6" # Major and minor versions of this kernel.
		declare -g LINUXCONFIG='linux-cix-2025-Q3'
		KERNELSOURCE='https://github.com/radxa/kernel.git'
		KERNELBRANCH='branch:ee8f6/48bff/cix_p1_K6.6_2025Q3_dev_patch'
		KERNELPATCHDIR='cix-2025-Q3'
		declare -g -i KERNEL_GIT_CACHE_TTL=120 # 2 minutes; this is a high-traffic repo
		enable_extension "grub"
		declare -g GRUB_CMDLINE_LINUX_DEFAULT="acpi=force kasan=off rootwait rw"
		;;

esac

family_tweaks_bsp() {
	:
}

# Custom kernel config: use defconfig from kernel source + cix.config fragment
function custom_kernel_config__cix_use_source_defconfig() {
	# This hook is called twice - once for hashing and once with .config present
	kernel_config_modifying_hashes+=("cix-use-defconfig-${BRANCH}")
	# Add modifications to hash to ensure proper cache invalidation
	kernel_config_modifying_hashes+=("CONFIG_LOCALVERSION=unset")
	kernel_config_modifying_hashes+=("CONFIG_CIX_CORE_CTL=n")
	kernel_config_modifying_hashes+=("CONFIG_DRM_NOUVEAU=n")
	kernel_config_modifying_hashes+=("CONFIG_TYPEC_DP_ALTMODE=n")
	kernel_config_modifying_hashes+=("CONFIG_INV_ICM42600_I2C=n")

	if [[ -f .config ]]; then
		display_alert "Using kernel defconfig from source" "arch/arm64/configs/defconfig" "info"

		# Start with kernel's defconfig (adjust path as needed)
		# Options: defconfig, arch/arm64/configs/cix_defconfig, etc.
		run_kernel_make defconfig

		# If there's a cix.config fragment file in the kernel source, merge it
		if [[ -f "arch/arm64/configs/cix.config" ]]; then
			display_alert "Merging CIX config fragment" "arch/arm64/configs/cix.config" "info"
			run_host_command_logged scripts/kconfig/merge_config.sh -m .config arch/arm64/configs/cix.config
		fi

		# Disable problematic configs for CIX
		display_alert "Disabling problematic kernel configs for CIX" "CIX-specific fixes" "info"
		kernel_config_set_n CONFIG_LOCALVERSION      # Armbian sets this via LOCALVERSION make parameter
		kernel_config_set_n CONFIG_CIX_CORE_CTL      # Referencing non existing function
		kernel_config_set_n CONFIG_DRM_NOUVEAU       # drm_gpuvm.h conflict
		kernel_config_set_n CONFIG_TYPEC_DP_ALTMODE  # Non existing DP_CONF_SIGNALLING_SHIFT constant
		kernel_config_set_n CONFIG_INV_ICM42600_I2C  # Non existing INV_ICM42600_REG_DRIVE_CONFIG constant
	fi
}

post_family_tweaks_bsp__cix_gpu_firmware() {
	# Only add GPU firmware for 2025-Q3 branch
	if [[ "${BRANCH}" != "2025-Q3" ]]; then
		return 0
	fi

	display_alert "Adding CIX GPU firmware" "mali_csffw.bin" "info"

	# Firmware commit SHA from cix-linux proprietary repo
	declare firmware_commit_sha1="06fe36730b79ad9969f537571b0cf6395ed82c5a"

	# Destination directory for firmware
	declare destdir="${destination}/usr/lib/firmware"
	run_host_command_logged mkdir -p "${destdir}"

	# Fetch the firmware from GitLab
	fetch_from_repo "https://gitlab.com/cix-linux/cix_proprietary/cix_proprietary.git" "cix-gpu-firmware" "commit:${firmware_commit_sha1}" "yes"

	# Source directory where the firmware is located
	declare srcdir="${SRC}/cache/sources/cix-gpu-firmware/${firmware_commit_sha1}"

	# Copy the Mali CSF firmware file
	if [[ -f "${srcdir}/cix_proprietary-debs/cix-gpu-umd/usr/lib/firmware/mali_csffw.bin" ]]; then
		run_host_command_logged cp -v "${srcdir}/cix_proprietary-debs/cix-gpu-umd/usr/lib/firmware/mali_csffw.bin" "${destdir}/mali_csffw.bin"
		display_alert "CIX GPU firmware installed successfully" "mali_csffw.bin" "info"
	else
		display_alert "CIX GPU firmware file not found" "mali_csffw.bin" "wrn"
	fi
}
